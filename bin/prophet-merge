#!/usr/bin/perl

use warnings;
use strict;

use Prophet::Sync::Source::SVN;
use Params::Validate;
use Getopt::Long;
use Prophet::CLI;
Prophet::CLI->new; # to get res handle;

my $opts = {};

GetOptions( $opts, 'from=s', 'to=s' );
validate_options($opts);

my $source = Prophet::Sync::Source->new( { url => $opts->{'from'} } );
my $target = Prophet::Sync::Source->new( { url => $opts->{'to'} } );

if ( $target->uuid eq $source->uuid ) {
fatal_error( "You appear to be trying to merge two identical replicas. "
        . "Either you're trying to merge a replica to itself or "
        . "someone did a bad job cloning your database" );
}

if ( !$target->accepts_changesets ) {
fatal_error( $target->url . " does not accept changesets. Perhaps it's unwritable or something" );
}

$target->import_changesets( from => $source );

exit(0);

sub validate_options {
    my $opts = shift;
    for (qw(from to)) {
        die "You need to specify a --$_ url" unless ( $opts->{$_} );
    }
}

sub fatal_error {
    my $reason = shift;
    die $reason."\n";

}

